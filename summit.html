<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Managers & Directors Summit Registration - Campus Stores Canada</title>
    <link rel="icon" type="image/png" href="https://images.squarespace-cdn.com/content/v1/5ec55d5d28a93e0e18d2eeb4/1600096854522-HS7NUI12I1ML6SPJFLLY/Artboard+1.png?format=1500w">

    <!-- External Fonts -->
    <link rel="stylesheet" href="https://use.typekit.net/ilr6ctr.css">

    <!-- Custom Stylesheet -->
    <link rel="stylesheet" href="vendor-wizard.css">

    <!-- Summit-Specific Styles -->
    <style>
        /* Layout Adjustments for Summit Registration */
        .welcome-section {
            width: 65% !important;
            max-width: 800px;
            margin-top: 80px !important;
        }

        .welcome-title {
            font-size: 2.5vw !important;
            margin-bottom: 25px !important;
        }

        /* Constrain width of step sections to match welcome section */
        .content-section:not(#welcomeSection) {
            max-width: 800px;
            width: 65%;
            margin-left: 0;
            margin-right: auto;
        }

        .content-section h1 {
            font-size: 2.2vw;
            margin-bottom: 1.5em;
        }

        .content-section .progress-indicator {
            margin-bottom: 2em;
        }

        /* Scrollable Agreement Container */
        .scroll-to-accept-container {
            position: relative;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 2em;
            margin: 0.5em 0 1.5em 0;
            background: #f8f9fa;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .scroll-to-accept-container .agreement-content {
            background: transparent;
            padding: 0;
            margin: 0;
            border: none;
            max-height: none;
            overflow: visible;
        }

        .scroll-indicator {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(248, 249, 250, 1) 60%, rgba(248, 249, 250, 0));
            padding: 1.5em 1em 0.5em;
            text-align: center;
            font-weight: 600;
            color: #0071bc;
            font-size: 0.95em;
            pointer-events: none;
            transition: opacity 0.3s ease;
            animation: pulse-scroll 2s ease-in-out infinite;
        }

        .scroll-indicator.hidden {
            opacity: 0;
            animation: none;
        }

        /* Pulse animation for scroll indicator */
        @keyframes pulse-scroll {
            0%, 100% {
                opacity: 1;
                transform: translateY(0);
            }
            50% {
                opacity: 0.6;
                transform: translateY(-3px);
            }
        }

        /* Pulse animation for checkbox */
        @keyframes pulse-checkbox {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(0, 113, 188, 0.4);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(0, 113, 188, 0);
            }
        }

        .checkbox-item {
            transition: all 0.3s ease;
        }

        .checkbox-item.pulse {
            animation: pulse-checkbox 2s ease-in-out infinite;
            border-radius: 8px;
        }

        .checkbox-item input[type="checkbox"]:disabled + label {
            opacity: 0.4;
            cursor: not-allowed;
            color: #999;
        }

        .checkbox-item input[type="checkbox"]:disabled {
            cursor: not-allowed;
            opacity: 0.4;
        }

        .checkbox-item input[type="checkbox"]:not(:disabled) + label {
            opacity: 1;
            color: inherit;
        }

        /* Serious/Confidential Tone Styling */
        .summit-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1.5em;
            margin: 2em 0;
            border-radius: 4px;
        }

        .summit-critical {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 1.5em;
            margin: 2em 0;
            border-radius: 4px;
        }

        .summit-info {
            background: #d1ecf1;
            border-left: 4px solid #0c5460;
            padding: 1.5em;
            margin: 2em 0;
            border-radius: 4px;
        }

        .agreement-text {
            background: #f8f9fa;
            padding: 2em;
            margin: 1.5em 0;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.8;
        }

        .agreement-text h3 {
            margin-top: 1.5em;
            margin-bottom: 0.8em;
            color: #2c3e50;
        }

        .agreement-text p {
            margin-bottom: 1em;
        }

        .agreement-text ul {
            margin-left: 2em;
            margin-bottom: 1em;
        }

        .agreement-content {
            margin: 2em 0;
            line-height: 1.7;
            color: #333333;
        }

        .agreement-content h3 {
            font-family: 'davis-sans', sans-serif;
            font-weight: 600;
            font-size: 1.1em;
            color: #000000;
            margin-top: 1.8em;
            margin-bottom: 0.8em;
        }

        .agreement-content h3:first-child {
            margin-top: 0;
        }

        .agreement-content p {
            margin-bottom: 1.1em;
            line-height: 1.7;
        }

        .agreement-content ul {
            margin-bottom: 1.2em;
            margin-left: 1.8em;
        }

        .agreement-content li {
            margin-bottom: 0.5em;
            line-height: 1.6;
        }

        .checkbox-group {
            margin: 1.5em 0;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1em;
            padding: 1em;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            border-color: #0071bc;
        }

        .checkbox-item.checked {
            border-color: #28a745;
            background: #f8fff9;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 1em;
            margin-top: 0.3em;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            flex: 1;
            line-height: 1.6;
            font-size: 0.95em;
        }

        .file-upload-area {
            margin: 2em 0;
            padding: 2em;
            border: 2px dashed #ced4da;
            border-radius: 8px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            border-color: #0071bc;
            background: #f0f8ff;
        }

        .file-upload-area.has-file {
            border-color: #28a745;
            background: #f8fff9;
            border-style: solid;
        }

        .file-upload-label {
            display: block;
            cursor: pointer;
            padding: 1em;
        }

        .file-upload-input {
            display: none;
        }

        .file-name-display {
            margin-top: 1em;
            padding: 0.8em;
            background: white;
            border-radius: 4px;
            font-weight: 500;
            color: #28a745;
        }

        .radio-group {
            margin: 1.5em 0;
        }

        .radio-item {
            display: flex;
            align-items: center;
            margin-bottom: 1em;
            padding: 1.2em;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .radio-item:hover {
            border-color: #0071bc;
        }

        .radio-item.selected {
            border-color: #0071bc;
            background: #f0f8ff;
        }

        .radio-item input[type="radio"] {
            margin-right: 1em;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .radio-item label {
            cursor: pointer;
            flex: 1;
            font-weight: 500;
        }

        .explanation-text {
            color: #6c757d;
            font-size: 0.9em;
            font-style: italic;
            margin-top: 0.5em;
            line-height: 1.5;
        }

        .contact-selection {
            margin: 2em 0;
        }

        .contact-card {
            padding: 1.2em;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 1em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .contact-card:hover {
            border-color: #0071bc;
        }

        .contact-card.selected {
            border-color: #0071bc;
            background: #f0f8ff;
        }

        .contact-name {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 0.3em;
        }

        .contact-details {
            color: #6c757d;
            font-size: 0.9em;
        }

        .add-new-person-btn {
            padding: 1em;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-new-person-btn:hover {
            border-color: #0071bc;
            background: #f0f8ff;
        }

        .new-person-form {
            margin-top: 1.5em;
            padding: 1.5em;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .form-field {
            margin-bottom: 1.2em;
        }

        .form-field label {
            display: block;
            margin-bottom: 0.5em;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-field input {
            width: 100%;
            padding: 0.8em;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 1em;
        }

        .form-field input:focus {
            outline: none;
            border-color: #0071bc;
            box-shadow: 0 0 0 3px rgba(0, 113, 188, 0.1);
        }

        .field-error {
            color: #dc3545;
            font-size: 0.85em;
            margin-top: 0.3em;
            display: none;
        }

        .field-error.visible {
            display: block;
        }

        .progress-indicator {
            margin-bottom: 2em;
            padding: 1em;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .progress-text {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 0.5em;
        }

        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0071bc, #00a4e4);
            transition: width 0.3s ease;
        }

        /* Primary Member Verification Section */
        .primary-member-section {
            margin: 2em 0;
            padding: 0;
        }

        .primary-member-section h3 {
            font-family: 'davis-sans', sans-serif;
            font-weight: 600;
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 1em;
        }

        .primary-member-card {
            background: #ffffff;
            border: 2px solid #0071bc;
            border-radius: 8px;
            padding: 1.5em;
            margin-bottom: 1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5em;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-family: 'davis-sans', sans-serif;
            font-weight: 600;
            font-size: 1.2em;
            color: #000000;
            margin-bottom: 0.3em;
        }

        .member-title,
        .member-email,
        .member-phone {
            font-size: 0.95em;
            color: #495057;
            margin-bottom: 0.25em;
        }

        .edit-details-btn {
            background: #ffffff;
            color: #0071bc;
            border: 2px solid #0071bc;
            padding: 0.7em 1.5em;
            border-radius: 6px;
            font-family: 'davis-sans', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .edit-details-btn:hover {
            background: #0071bc;
            color: #ffffff;
        }

        .verification-prompt {
            font-size: 0.9em;
            color: #6c757d;
            font-style: italic;
            margin-top: 0.5em;
        }

        /* Edit Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #ffffff;
            border-radius: 12px;
            padding: 2em;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5em;
            padding-bottom: 1em;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-title {
            font-family: 'davis-sans', sans-serif;
            font-weight: 600;
            font-size: 1.4em;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: #000000;
        }

        .modal-body {
            margin-bottom: 1.5em;
        }

        .modal-field {
            margin-bottom: 1.2em;
        }

        .modal-field label {
            display: block;
            font-family: 'davis-sans', sans-serif;
            font-weight: 500;
            font-size: 0.95em;
            color: #2c3e50;
            margin-bottom: 0.5em;
        }

        .modal-field label .required {
            color: #dc3545;
        }

        .modal-field input {
            width: 100%;
            padding: 0.8em;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-family: 'davis-sans', sans-serif;
            font-size: 1em;
            transition: border-color 0.2s ease;
        }

        .modal-field input:focus {
            outline: none;
            border-color: #0071bc;
            box-shadow: 0 0 0 3px rgba(0, 113, 188, 0.1);
        }

        .modal-field input.error {
            border-color: #dc3545;
        }

        .modal-field .error-message {
            color: #dc3545;
            font-size: 0.85em;
            margin-top: 0.3em;
            display: none;
        }

        .modal-field .error-message.visible {
            display: block;
        }

        .modal-footer {
            display: flex;
            gap: 1em;
            justify-content: flex-end;
        }

        .modal-cancel-btn,
        .modal-save-btn {
            padding: 0.8em 1.5em;
            border-radius: 6px;
            font-family: 'davis-sans', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid;
        }

        .modal-cancel-btn {
            background: #ffffff;
            color: #6c757d;
            border-color: #6c757d;
        }

        .modal-cancel-btn:hover {
            background: #6c757d;
            color: #ffffff;
        }

        .modal-save-btn {
            background: #0071bc;
            color: #ffffff;
            border-color: #0071bc;
        }

        .modal-save-btn:hover {
            background: #005a94;
            border-color: #005a94;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .welcome-section {
                width: 100% !important;
                margin-top: 40px !important;
            }

            .welcome-title {
                font-size: 6vw !important;
            }

            .content-section:not(#welcomeSection) {
                width: 100%;
                max-width: none;
            }

            .content-section h1 {
                font-size: 6vw;
            }

            .scroll-to-accept-container {
                max-height: 300px;
                padding: 1.5em;
                margin: 0.5em 0 1em 0;
            }

            .primary-member-card {
                flex-direction: column;
                align-items: stretch;
                gap: 1em;
            }

            .edit-details-btn {
                width: 100%;
                text-align: center;
            }

            .modal-content {
                padding: 1.5em;
            }

            .modal-footer {
                flex-direction: column-reverse;
            }

            .modal-cancel-btn,
            .modal-save-btn {
                width: 100%;
            }
        }

        /* Tablet responsive adjustments */
        @media (min-width: 769px) and (max-width: 1024px) {
            .welcome-section {
                width: 70% !important;
            }

            .welcome-title {
                font-size: 3vw !important;
            }

            .content-section:not(#welcomeSection) {
                width: 70%;
            }

            .content-section h1 {
                font-size: 3vw;
            }
        }
    </style>
</head>
<body>
    <div class="wizard-container">
        <!-- Loading State -->
        <div id="loadingState" class="loading active">
            <div class="loading-title">
                Loading<span class="dots">
                    <span class="dot">.</span>
                    <span class="dot">.</span>
                    <span class="dot">.</span>
                </span>
            </div>
        </div>

        <!-- Upload Animation State -->
        <div class="uploading-state" id="uploadingState">
            <div class="uploading-title">
                Uploading<span class="dots">
                    <span class="dot">.</span>
                    <span class="dot">.</span>
                    <span class="dot">.</span>
                </span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="wizard-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="logo-section">
                    <div class="logo-container">
                        <img src="https://images.squarespace-cdn.com/content/v1/5ec55d5d28a93e0e18d2eeb4/1600096854522-HS7NUI12I1ML6SPJFLLY/Artboard+1.png?format=1500w" alt="CSC Logo" class="csc-logo">
                        <div id="organizationLogo" class="organization-logo-container"></div>
                    </div>
                </div>
                <h2 class="sidebar-title">Managers & Directors Summit</h2>
                <div class="step-indicators">
                    <div class="step-indicator active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">Your Attendance</div>
                    </div>
                    <div class="step-indicator" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">Format & Agreement</div>
                    </div>
                    <div class="step-indicator" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-label">Designate Alternate</div>
                    </div>
                    <div class="step-indicator" data-step="4">
                        <div class="step-number">4</div>
                        <div class="step-label">Confirmation</div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Mobile Progress Bar -->
                <div class="mobile-progress">
                    <div class="mobile-progress-fill" style="width: 0%"></div>
                </div>

                <!-- Welcome Section -->
                <div id="welcomeSection" class="content-section active">
                    <div class="welcome-container">
                        <div class="welcome-section">
                            <h1 class="welcome-title">Managers & Directors Summit Registration</h1>

                            <div class="summit-info">
                                <p><strong>This is a highly confidential meeting requiring explicit agreements at multiple decision points.</strong></p>
                                <p>This registration process will guide you through several important decisions and require your acknowledgment of strict confidentiality requirements.</p>
                            </div>

                            <div class="summit-warning">
                                <p><strong>Before you begin:</strong></p>
                                <ul>
                                    <li>You will need to review and sign confidentiality agreements</li>
                                    <li>You must be able to upload signed PDF or image files</li>
                                    <li>All checkboxes and agreements are required - no exceptions</li>
                                    <li>This process should take 10-15 minutes to complete</li>
                                </ul>
                            </div>

                            <!-- Primary Member Verification -->
                            <div id="primaryMemberSection" class="primary-member-section" style="display: none;">
                                <h3>We're registering:</h3>
                                <div class="primary-member-card">
                                    <div class="member-info">
                                        <div class="member-name" id="pmDisplayName">Loading...</div>
                                        <div class="member-title" id="pmDisplayTitle">-</div>
                                        <div class="member-email" id="pmDisplayEmail">-</div>
                                        <div class="member-phone" id="pmDisplayPhone">-</div>
                                    </div>
                                    <button class="edit-details-btn" onclick="openPrimaryMemberModal()">
                                        Edit Details
                                    </button>
                                </div>
                                <p class="verification-prompt">Please verify your information is correct before proceeding.</p>
                            </div>

                            <button class="get-started-btn" onclick="startWizard()">
                                Begin Registration <span>→</span>
                            </button>
                        </div>
                    </div>
                </div>

            <!-- Step 1: Attendance Decision (Primary Member) -->
            <div id="step2Section" class="content-section">
                <div class="progress-indicator">
                    <div class="progress-text">Step 1 of 4</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 25%;"></div>
                    </div>
                </div>

                <h1>Will You Be Attending?</h1>

                <div class="radio-group">
                    <p style="font-weight: 600; margin-bottom: 1em;">Will you be attending the Managers & Directors Summit?</p>

                    <div class="radio-item" onclick="selectPrimaryAttendance('yes')">
                        <input type="radio" name="primaryAttendance" id="primaryAttendYes" value="yes">
                        <label for="primaryAttendYes">Yes, I will attend</label>
                    </div>

                    <div class="radio-item" onclick="selectPrimaryAttendance('no')">
                        <input type="radio" name="primaryAttendance" id="primaryAttendNo" value="no">
                        <label for="primaryAttendNo">No, I will not attend</label>
                    </div>
                </div>

                <button class="previous-btn" onclick="previousStep()">
                    <span>←</span>
                    Previous step
                </button>
                <button class="next-btn" id="step2NextBtn" onclick="nextStep()" disabled>
                    Next step
                    <span>→</span>
                </button>
            </div>

            <!-- Step 3a: Attendance Format (Primary Member) -->
            <div id="step3aSection" class="content-section">
                <div class="progress-indicator">
                    <div class="progress-text">Step 2 of 4</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 50%;"></div>
                    </div>
                </div>

                <h1>How Will You Attend?</h1>

                <div class="radio-group">
                    <p style="font-weight: 600; margin-bottom: 1em;">Please select your attendance format:</p>

                    <div class="radio-item" onclick="selectPrimaryFormat('in-person')">
                        <input type="radio" name="primaryFormat" id="primaryFormatInPerson" value="in-person">
                        <label for="primaryFormatInPerson">
                            In Person
                            <div class="explanation-text">I will attend the summit in person at the designated location</div>
                        </label>
                    </div>

                    <div class="radio-item" onclick="selectPrimaryFormat('virtual')">
                        <input type="radio" name="primaryFormat" id="primaryFormatVirtual" value="virtual">
                        <label for="primaryFormatVirtual">
                            Virtual (Online)
                            <div class="explanation-text">I will attend the summit remotely via video conference</div>
                        </label>
                    </div>
                </div>

                <button class="previous-btn" onclick="previousStep()">
                    <span>←</span>
                    Previous step
                </button>
                <button class="next-btn" id="step3aNextBtn" onclick="nextStep()" disabled>
                    Next step
                    <span>→</span>
                </button>
            </div>

            <!-- Step 3b: Traffic Light Protocol -->
            <div id="step3bSection" class="content-section">
                <div class="progress-indicator">
                    <div class="progress-text">Step 2 of 4 - Traffic Light Protocol Red</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 50%;"></div>
                    </div>
                </div>

                <h1>Traffic Light Protocol Red</h1>

                <div class="scroll-to-accept-container" id="tlpRedScrollContainer">
                    <div class="agreement-content">
                        <h3>Before you register, you need to understand what you're agreeing to.</h3>

                        <p>This summit operates under <strong>"Traffic Light Protocol Red"</strong> - the highest level of confidentiality. Everything discussed in this meeting stays in the room where it's discussed. No exceptions.</p>

                        <h3>What We'll Be Discussing</h3>
                        <p>Frank conversations about:</p>
                        <ul>
                            <li>The real financial situation of your campus store</li>
                            <li>Staffing levels, changes, and expertise needs</li>
                            <li>Operational challenges and solutions</li>
                            <li>Strategic decisions your institution is requiring</li>
                        </ul>

                        <h3>Who Can Attend</h3>
                        <p>This meeting is designed for management-level staff who can speak candidly about their store's operations and strategic decisions.</p>

                        <p><strong>If you are the primary CSC member:</strong> You can attend yourself or designate someone else from your team.</p>

                        <p><strong>If you are designating someone else:</strong> You are personally responsible for ensuring they understand and will follow these rules. The CSC Board reserves the right to exclude any designee if they believe that person cannot contribute meaningfully to the conversation.</p>

                        <h3>The Rules</h3>
                        <p><strong>In-Person:</strong> "What's said in the room stays in the room. No recording of any kind. No sharing notes or information afterward."</p>

                        <p><strong>Virtual:</strong> You must be alone, camera on, microphone active throughout, no recording, no sharing information afterward.</p>

                        <h3>Consequences</h3>
                        <p>Breaking confidentiality results in immediate membership termination with no appeals or refunds.</p>
                    </div>
                    <div class="scroll-indicator" id="tlpRedScrollIndicator">
                        ↓ Scroll down to continue ↓
                    </div>
                </div>

                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="primaryAgree1" onchange="updateStep3bState()" disabled>
                        <label for="primaryAgree1">
                            <span id="tlpRedCheckboxLabel">Please scroll to the bottom to enable this checkbox</span>
                        </label>
                    </div>
                </div>

                <button class="previous-btn" onclick="previousStep()">
                    <span>←</span>
                    Previous step
                </button>
                <button class="next-btn" id="step3bNextBtn" onclick="nextStep()" disabled>
                    Next step
                    <span>→</span>
                </button>
            </div>

            <!-- Step 3c: Employment Contracts -->
            <div id="step3cSection" class="content-section">
                <div class="progress-indicator">
                    <div class="progress-text">Step 2 of 4 - Employment Contracts</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 50%;"></div>
                    </div>
                </div>

                <div class="step-header">
                    <h2 class="step-title-main">Employment Contract Review</h2>
                    <p class="step-subtitle">Important consideration about collective bargaining agreements</p>
                </div>

                <div class="agreement-content">
                    <p>If you or your designee are covered by a collective bargaining agreement, you must review your contract to ensure there are no provisions that would require you to disclose information from this meeting.</p>

                    <p>By registering, you assume full responsibility for any conflicts between this confidentiality agreement and your employment contract.</p>
                </div>

                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="primaryAgree2" onchange="updateStep3cState()">
                        <label for="primaryAgree2">I have reviewed applicable employment contracts and accept responsibility for any conflicts</label>
                    </div>
                </div>

                <button class="previous-btn" onclick="previousStep()">
                    <span>←</span>
                    Previous step
                </button>
                <button class="next-btn" id="step3cNextBtn" onclick="nextStep()" disabled>
                    Next step
                    <span>→</span>
                </button>
            </div>

            <!-- Step 3d: Digital Signature -->
            <div id="step3dSection" class="content-section">
                <div class="progress-indicator">
                    <div class="progress-text">Step 2 of 4 - Sign Agreement</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 50%;"></div>
                    </div>
                </div>

                <div class="step-header">
                    <h2 class="step-title-main">Sign Confidentiality Agreement</h2>
                    <p class="step-subtitle">Review the terms and sign below to complete your confidentiality acknowledgment</p>
                </div>

                <div class="agreement-content">
                    <h3>Summary of Terms</h3>

                    <p>By signing this agreement, you acknowledge and agree to the following:</p>

                    <p><strong>Traffic Light Protocol Red Confidentiality:</strong> All information discussed at the Managers & Directors Summit is subject to the highest level of confidentiality. What is said in the meeting stays in the meeting. No recording of any kind is permitted. No sharing of information or notes afterward.</p>

                    <p><strong>Attendance Requirements:</strong></p>
                    <ul>
                        <li><strong>In-Person:</strong> No recording devices, no note-sharing, complete confidentiality</li>
                        <li><strong>Virtual:</strong> Must be alone with camera on and microphone active throughout the meeting</li>
                    </ul>

                    <p><strong>Employment Contract Responsibility:</strong> If you or your designee are covered by a collective bargaining agreement, you have reviewed your employment contract and accept full responsibility for any conflicts with this confidentiality agreement.</p>

                    <p><strong>Consequences of Breach:</strong> Violation of this confidentiality agreement will result in immediate termination of CSC membership with no appeals process and no refunds.</p>

                    <p><strong>Designee Responsibility:</strong> If you are designating someone else to attend, you are personally responsible for ensuring they understand and will comply with all of these terms. The CSC Board reserves the right to exclude any designee who cannot contribute meaningfully to the conversation.</p>
                </div>

                <div class="signature-section">
                    <h3>Digital Signature</h3>
                    <p style="margin-bottom: 1em; color: #666;">Please sign below using your mouse or touchscreen</p>

                    <div class="signature-pad-container">
                        <canvas id="primarySignatureCanvas" class="signature-canvas"></canvas>
                    </div>

                    <button type="button" class="clear-signature-btn" onclick="clearPrimarySignature()">
                        Clear Signature
                    </button>
                </div>

                <button class="previous-btn" onclick="previousStep()">
                    <span>←</span>
                    Previous step
                </button>
                <button class="next-btn" id="step3dNextBtn" onclick="nextStep()" disabled>
                    Next step
                    <span>→</span>
                </button>
            </div>

            <!-- Step 4: Designate Alternate -->
            <div id="step4Section" class="content-section">
                <div class="progress-indicator">
                    <div class="progress-text">Step 3 of 4</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 75%;"></div>
                    </div>
                </div>

                <h1>Designate an Alternate</h1>

                <div class="summit-info">
                    <p id="step4IntroText"></p>
                </div>

                <div class="radio-group">
                    <p style="font-weight: 600; margin-bottom: 1em;" id="step4QuestionText"></p>

                    <div class="radio-item" onclick="selectDesignateAlternate('yes')">
                        <input type="radio" name="designateAlternate" id="designateYes" value="yes">
                        <label for="designateYes" id="designateYesLabel"></label>
                    </div>

                    <div class="radio-item" onclick="selectDesignateAlternate('no')">
                        <input type="radio" name="designateAlternate" id="designateNo" value="no">
                        <label for="designateNo" id="designateNoLabel"></label>
                    </div>
                </div>

                <div id="noDesignateMessage" style="display: none;" class="summit-info">
                    <p>Thank you for your response. Click Continue to complete your registration.</p>
                </div>

                <button class="previous-btn" onclick="previousStep()">
                    <span>←</span>
                    Previous step
                </button>
                <button class="next-btn" id="step4NextBtn" onclick="nextStep()" disabled>
                    Next step
                    <span>→</span>
                </button>
            </div>

            <!-- Step 5: Alternate Selection -->
            <div id="step5Section" class="content-section">
                <div class="progress-indicator">
                    <div class="progress-text">Step 3 of 4 - Select Alternate</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 75%;"></div>
                    </div>
                </div>

                <h1>Select Your Alternate</h1>

                <div class="summit-info">
                    <p>Choose an existing contact or add a new person from your team:</p>
                </div>

                <div class="contact-selection" id="existingContacts">
                    <!-- Existing contacts will be populated here -->
                </div>

                <div class="add-new-person-btn" onclick="toggleNewPersonForm()">
                    <p style="font-weight: 600;">+ Add a New Person</p>
                </div>

                <div id="newPersonForm" class="new-person-form" style="display: none;">
                    <h3 style="margin-top: 0;">New Alternate Information</h3>

                    <div class="form-field">
                        <label for="alternateName">Full Name *</label>
                        <input type="text" id="alternateName" placeholder="Jane Smith">
                        <div class="field-error" id="alternateNameError">Name is required</div>
                    </div>

                    <div class="form-field">
                        <label for="alternateTitle">Title/Position *</label>
                        <input type="text" id="alternateTitle" placeholder="Assistant Manager">
                        <div class="field-error" id="alternateTitleError">Title is required</div>
                    </div>

                    <div class="form-field">
                        <label for="alternateEmail">Email Address *</label>
                        <input type="email" id="alternateEmail" placeholder="jane.smith@university.edu">
                        <div class="field-error" id="alternateEmailError">Valid email is required</div>
                    </div>

                    <div class="form-field">
                        <label for="alternatePhone">Phone Number *</label>
                        <input type="tel" id="alternatePhone" placeholder="(555) 123-4567">
                        <div class="field-error" id="alternatePhoneError">Phone number is required</div>
                    </div>
                </div>

                <button class="previous-btn" onclick="previousStep()">
                    <span>←</span>
                    Previous step
                </button>
                <button class="next-btn" id="step5NextBtn" onclick="nextStep()" disabled>
                    Next step
                    <span>→</span>
                </button>
            </div>

            <!-- Step 6: Alternate Attendance Format -->
            <div id="step6Section" class="content-section">
                <div class="progress-indicator">
                    <div class="progress-text">Step 3 of 4 - Alternate Format</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 75%;"></div>
                    </div>
                </div>

                <h1>Alternate Attendance Format</h1>

                <div class="radio-group">
                    <p style="font-weight: 600; margin-bottom: 1em;">How will <span id="alternateNameDisplay"></span> attend?</p>

                    <div class="radio-item" onclick="selectAlternateFormat('in-person')">
                        <input type="radio" name="alternateFormat" id="alternateFormatInPerson" value="in-person">
                        <label for="alternateFormatInPerson">
                            In Person
                            <div class="explanation-text">They will attend the summit in person at the designated location</div>
                        </label>
                    </div>

                    <div class="radio-item" onclick="selectAlternateFormat('virtual')">
                        <input type="radio" name="alternateFormat" id="alternateFormatVirtual" value="virtual">
                        <label for="alternateFormatVirtual">
                            Virtual (Online)
                            <div class="explanation-text">They will attend the summit remotely via video conference</div>
                        </label>
                    </div>
                </div>

                <button class="previous-btn" onclick="previousStep()">
                    <span>←</span>
                    Previous step
                </button>
                <button class="next-btn" id="step6NextBtn" onclick="nextStep()" disabled>
                    Next step
                    <span>→</span>
                </button>
            </div>

            <!-- Step 7: Primary Member Certification for Alternate -->
            <div id="step7Section" class="content-section">
                <div class="progress-indicator">
                    <div class="progress-text">Step 3 of 4 - Certification</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 75%;"></div>
                    </div>
                </div>

                <h1>Primary Member Certification</h1>

                <div class="summit-warning">
                    <p><strong>By designating <span id="certificationAlternateName"></span>, you certify the following:</strong></p>
                </div>

                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="certify1" onchange="updateCertificationState()">
                        <label for="certify1">I certify that this person understands and will uphold confidentiality requirements</label>
                    </div>

                    <div class="checkbox-item">
                        <input type="checkbox" id="certify2" onchange="updateCertificationState()">
                        <label for="certify2">I understand the CSC Board may exclude this designee if they determine they cannot meaningfully contribute</label>
                    </div>
                </div>

                <div class="file-upload-area" id="certificationUploadArea">
                    <label for="certificationFile" class="file-upload-label">
                        <p style="font-weight: 600; margin-bottom: 0.5em;">Upload Signed Primary Member Certification</p>
                        <p style="color: #6c757d; font-size: 0.9em;">Click to select a PDF or image file (JPG, PNG)</p>
                        <p style="color: #6c757d; font-size: 0.85em; margin-top: 0.5em;">Maximum file size: 5MB</p>
                    </label>
                    <input type="file" id="certificationFile" class="file-upload-input" accept=".pdf,.jpg,.jpeg,.png" onchange="handleCertificationUpload(event)">
                    <div id="certificationFileName" class="file-name-display" style="display: none;"></div>
                </div>

                <div class="summit-info">
                    <p><strong>Next Step:</strong> After you submit this certification, <span id="emailAlternateName"></span> will receive an email with a unique link to complete their own confidentiality agreement.</p>
                </div>

                <button class="previous-btn" onclick="previousStep()">
                    <span>←</span>
                    Previous step
                </button>
                <button class="next-btn" id="step7NextBtn" onclick="nextStep()" disabled>
                    Next step
                    <span>→</span>
                </button>
            </div>

            <!-- Step 8: Confirmation -->
            <div id="step8Section" class="content-section">
                <div class="progress-indicator">
                    <div class="progress-text">Complete!</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 100%;"></div>
                    </div>
                </div>

                <h1>Registration Confirmed</h1>

                <div class="summit-info" id="confirmationMessage">
                    <!-- Dynamic confirmation message will be inserted here -->
                </div>

                <div class="summit-warning" id="nextStepsMessage">
                    <!-- Dynamic next steps message will be inserted here -->
                </div>

                <div style="margin-top: 3em; text-align: center;">
                    <p style="color: #6c757d;">If you have any questions, please contact <a href="mailto:info@campusstores.ca">info@campusstores.ca</a></p>
                </div>
            </div>

            </div><!-- /main-content -->
        </div><!-- /wizard-content -->
    </div><!-- /wizard-container -->

    <!-- JavaScript -->
    <script>
        // Global State
        let currentStep = 0;
        let token = '';
        let organizationData = {};
        let organizationContacts = [];

        // Primary Member State
        let primaryMemberContact = null;
        let primaryMemberEdits = {
            name: null,
            title: null,
            email: null,
            phone: null
        };

        // Registration State
        let registrationState = {
            // Identity
            isPrimaryMember: null,

            // Primary Member
            primaryIsAttending: null,
            primaryFormat: null,
            primaryAgreementChecks: [],
            primaryAgreementFile: null,
            primaryAgreementUrl: null,
            primaryVirtualAgreed: false,
            primaryBreachAck: false,

            // Designee
            hasDesignee: null,
            designeeContact: null,
            designeeIsNew: false,
            designeeFormat: null,

            // Certification
            certificationChecks: [],
            certificationFile: null,
            certificationUrl: null
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Get token from URL
            const urlParams = new URLSearchParams(window.location.search);
            token = urlParams.get('token');

            if (!token) {
                hideLoading();
                alert('No token provided. Please use the link from your email.');
                return;
            }

            // Load organization data and primary member info on page load
            await loadOrganizationData();

            // Initialize signature canvas
            initPrimarySignatureCanvas();

            // Initialize scroll-to-accept for TLP Red page
            initTLPRedScrollDetection();
        });

        async function loadOrganizationData() {
            try {
                const response = await fetch(`/api/get-organization?token=${token}`);
                const data = await response.json();

                if (data.error) {
                    alert('Invalid token or organization not found.');
                    return;
                }

                organizationData = data;

                // Populate organization logo/name in sidebar
                const organizationLogoContainer = document.getElementById('organizationLogo');
                if (data.organization?.logo && !data.organization.logo.includes('${')) {
                    organizationLogoContainer.innerHTML = `<img src="${data.organization.logo}" alt="${data.organization.name || 'Organization'} Logo" class="organization-logo">`;
                } else if (data.organization?.name) {
                    organizationLogoContainer.innerHTML = `<div class="organization-name">${data.organization.name}</div>`;
                }

                // Load contacts and filter for primary member
                const contactsResponse = await fetch(`/api/get-organization-contacts?token=${token}`);
                const contactsData = await contactsResponse.json();
                organizationContacts = contactsData.contacts || [];

                // Find the primary contact (primary member)
                primaryMemberContact = organizationContacts.find(contact => contact.isPrimaryContact);

                if (primaryMemberContact) {
                    console.log('✅ Found primary member:', primaryMemberContact.name);
                    displayPrimaryMember();
                } else {
                    console.warn('⚠️ No primary member found in contacts');
                }

                hideLoading();
            } catch (error) {
                console.error('Error loading data:', error);
                hideLoading();
                alert('Error loading organization data. Please try again.');
            }
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.remove('active');
            document.querySelector('.wizard-content').classList.add('loaded');
        }

        function showLoading() {
            document.getElementById('loadingState').classList.add('active');
        }

        // ========================================
        // Primary Member Functions
        // ========================================

        // Display primary member in the card
        function displayPrimaryMember() {
            if (!primaryMemberContact) return;

            // Get current data (edits override original)
            const currentData = {
                name: primaryMemberEdits.name || primaryMemberContact.name,
                title: primaryMemberEdits.title || primaryMemberContact.roleTitle,
                email: primaryMemberEdits.email || primaryMemberContact.workEmail,
                phone: primaryMemberEdits.phone || primaryMemberContact.workPhone
            };

            // Update display
            document.getElementById('pmDisplayName').textContent = currentData.name || 'Unknown Name';
            document.getElementById('pmDisplayTitle').textContent = currentData.title || 'No title provided';
            document.getElementById('pmDisplayEmail').textContent = currentData.email || 'No email provided';
            document.getElementById('pmDisplayPhone').textContent = formatPhoneForDisplay(currentData.phone) || 'No phone provided';

            // Show the section
            document.getElementById('primaryMemberSection').style.display = 'block';
        }

        // Format phone number for display: (XXX) XXX-XXXX
        function formatPhoneForDisplay(phone) {
            if (!phone) return '';

            // Remove all non-digit characters
            const digits = phone.replace(/\D/g, '');

            // Format based on length
            if (digits.length === 10) {
                return `(${digits.substring(0, 3)}) ${digits.substring(3, 6)}-${digits.substring(6)}`;
            } else if (digits.length === 11 && digits[0] === '1') {
                return `+1 (${digits.substring(1, 4)}) ${digits.substring(4, 7)}-${digits.substring(7)}`;
            }

            // Return as-is if it doesn't match expected format
            return phone;
        }

        // Format phone number as user types
        function formatPhoneInput(input) {
            // Remove all non-digit characters
            let value = input.value.replace(/\D/g, '');

            // Limit to 10 digits
            value = value.substring(0, 10);

            // Format progressively
            let formatted = '';
            if (value.length > 0) {
                formatted = '(' + value.substring(0, 3);
            }
            if (value.length >= 4) {
                formatted += ') ' + value.substring(3, 6);
            }
            if (value.length >= 7) {
                formatted += '-' + value.substring(6, 10);
            }

            input.value = formatted;
        }

        // Open primary member edit modal
        function openPrimaryMemberModal() {
            if (!primaryMemberContact) return;

            // Populate modal with current data (edits or original)
            document.getElementById('pmName').value = primaryMemberEdits.name || primaryMemberContact.name || '';
            document.getElementById('pmTitle').value = primaryMemberEdits.title || primaryMemberContact.roleTitle || '';
            document.getElementById('pmEmail').value = primaryMemberEdits.email || primaryMemberContact.workEmail || '';

            const currentPhone = primaryMemberEdits.phone || primaryMemberContact.workPhone || '';
            document.getElementById('pmPhone').value = formatPhoneForDisplay(currentPhone);

            // Clear any previous error states
            clearModalErrors();

            // Add phone formatting listener
            const phoneInput = document.getElementById('pmPhone');
            phoneInput.addEventListener('input', function() {
                formatPhoneInput(this);
            });

            // Show modal
            document.getElementById('primaryMemberModal').classList.add('active');
        }

        // Close primary member edit modal
        function closePrimaryMemberModal() {
            document.getElementById('primaryMemberModal').classList.remove('active');
            clearModalErrors();
        }

        // Clear modal error messages
        function clearModalErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.classList.remove('visible');
            });
            document.querySelectorAll('.modal-field input').forEach(el => {
                el.classList.remove('error');
            });
        }

        // Validate email format
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Validate phone format (must be 10 digits)
        function isValidPhone(phone) {
            const digits = phone.replace(/\D/g, '');
            return digits.length === 10;
        }

        // Save primary member details
        async function savePrimaryMemberDetails() {
            // Get values
            const name = document.getElementById('pmName').value.trim();
            const title = document.getElementById('pmTitle').value.trim();
            const email = document.getElementById('pmEmail').value.trim();
            const phone = document.getElementById('pmPhone').value.trim();

            // Clear previous errors
            clearModalErrors();

            // Validate all fields
            let hasError = false;

            if (!name) {
                document.getElementById('pmName').classList.add('error');
                document.getElementById('pmNameError').classList.add('visible');
                hasError = true;
            }

            if (!title) {
                document.getElementById('pmTitle').classList.add('error');
                document.getElementById('pmTitleError').classList.add('visible');
                hasError = true;
            }

            if (!email || !isValidEmail(email)) {
                document.getElementById('pmEmail').classList.add('error');
                document.getElementById('pmEmailError').classList.add('visible');
                hasError = true;
            }

            if (!phone || !isValidPhone(phone)) {
                document.getElementById('pmPhone').classList.add('error');
                document.getElementById('pmPhoneError').classList.add('visible');
                hasError = true;
            }

            if (hasError) {
                return; // Don't save if validation fails
            }

            // Store edits
            primaryMemberEdits.name = name;
            primaryMemberEdits.title = title;
            primaryMemberEdits.email = email;
            primaryMemberEdits.phone = phone.replace(/\D/g, ''); // Store as digits only

            // Update the display
            displayPrimaryMember();

            // Update the contact in Notion
            await updatePrimaryMemberContact();

            // Close modal
            closePrimaryMemberModal();

            console.log('✅ Primary member details saved:', primaryMemberEdits);
        }

        // Update primary member contact in Notion
        async function updatePrimaryMemberContact() {
            if (!primaryMemberContact || !primaryMemberContact.id) {
                console.error('❌ No primary member contact to update');
                return;
            }

            try {
                const response = await fetch('/api/update-contact', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contactId: primaryMemberContact.id,
                        updates: {
                            name: primaryMemberEdits.name || primaryMemberContact.name,
                            roleTitle: primaryMemberEdits.title || primaryMemberContact.roleTitle,
                            workEmail: primaryMemberEdits.email || primaryMemberContact.workEmail,
                            workPhone: primaryMemberEdits.phone || primaryMemberContact.workPhone
                        }
                    })
                });

                if (response.ok) {
                    console.log('✅ Primary member contact updated in Notion');
                } else {
                    console.error('❌ Failed to update contact in Notion');
                }
            } catch (error) {
                console.error('❌ Error updating contact:', error);
            }
        }

        // ========================================
        // End Primary Member Functions
        // ========================================

        // ========================================
        // Scroll-to-Accept for TLP Red
        // ========================================

        let tlpRedScrolledToBottom = false;

        function initTLPRedScrollDetection() {
            const scrollContainer = document.getElementById('tlpRedScrollContainer');
            const scrollIndicator = document.getElementById('tlpRedScrollIndicator');
            const checkbox = document.getElementById('primaryAgree1');
            const checkboxLabel = document.getElementById('tlpRedCheckboxLabel');
            const checkboxItem = checkbox?.closest('.checkbox-item');

            if (!scrollContainer) return;

            // Check if user has scrolled to bottom
            function checkScrollPosition() {
                const scrollTop = scrollContainer.scrollTop;
                const scrollHeight = scrollContainer.scrollHeight;
                const clientHeight = scrollContainer.clientHeight;

                // Allow 5px tolerance for scroll detection
                const isAtBottom = scrollTop + clientHeight >= scrollHeight - 5;

                if (isAtBottom && !tlpRedScrolledToBottom) {
                    tlpRedScrolledToBottom = true;
                    scrollIndicator.classList.add('hidden');
                    checkbox.disabled = false;
                    checkboxLabel.textContent = 'I understand and agree to Traffic Light Protocol Red confidentiality requirements';

                    // Start pulsing the checkbox to indicate it needs to be checked
                    if (checkboxItem && !checkbox.checked) {
                        checkboxItem.classList.add('pulse');
                    }

                    console.log('✅ User scrolled to bottom of TLP Red agreement');
                }
            }

            // Add scroll listener
            scrollContainer.addEventListener('scroll', checkScrollPosition);

            // Listen for checkbox changes to remove pulse when checked
            checkbox.addEventListener('change', function() {
                if (this.checked && checkboxItem) {
                    checkboxItem.classList.remove('pulse');
                }
            });

            // Check initial position (in case content is short enough to not need scrolling)
            setTimeout(() => {
                checkScrollPosition();
            }, 100);
        }

        // ========================================
        // End Scroll-to-Accept
        // ========================================

        async function startWizard() {
            // Data is already loaded on page load, just transition to first step
            document.getElementById('welcomeSection').classList.remove('active');
            document.getElementById('step2Section').classList.add('active');
            currentStep = 1;
        }

        // Step 1: Primary Attendance
        function selectPrimaryAttendance(answer) {
            registrationState.primaryIsAttending = answer === 'yes';

            document.querySelectorAll('input[name="primaryAttendance"]').forEach(input => {
                input.parentElement.classList.remove('selected');
            });

            const selectedRadio = document.getElementById(`primaryAttend${answer === 'yes' ? 'Yes' : 'No'}`);
            selectedRadio.checked = true;
            selectedRadio.parentElement.classList.add('selected');

            document.getElementById('step2NextBtn').disabled = false;
        }

        // Step 3a: Primary Format
        function selectPrimaryFormat(format) {
            registrationState.primaryFormat = format;

            document.querySelectorAll('input[name="primaryFormat"]').forEach(input => {
                input.parentElement.classList.remove('selected');
            });

            const selectedRadio = document.getElementById(`primaryFormat${format === 'in-person' ? 'InPerson' : 'Virtual'}`);
            selectedRadio.checked = true;
            selectedRadio.parentElement.classList.add('selected');

            document.getElementById('step3aNextBtn').disabled = false;
        }

        // Step 3b: Primary Agreement - Signature Canvas
        let primarySignatureCanvas = null;
        let primarySignatureCtx = null;
        let primaryIsDrawing = false;
        let primaryHasSignature = false;

        function initPrimarySignatureCanvas() {
            primarySignatureCanvas = document.getElementById('primarySignatureCanvas');
            if (!primarySignatureCanvas) return;

            primarySignatureCtx = primarySignatureCanvas.getContext('2d');

            // Set canvas size
            const rect = primarySignatureCanvas.getBoundingClientRect();
            primarySignatureCanvas.width = rect.width;
            primarySignatureCanvas.height = 200;

            // Set drawing styles
            primarySignatureCtx.strokeStyle = '#000000';
            primarySignatureCtx.lineWidth = 2;
            primarySignatureCtx.lineCap = 'round';
            primarySignatureCtx.lineJoin = 'round';

            // Mouse events
            primarySignatureCanvas.addEventListener('mousedown', startPrimaryDrawing);
            primarySignatureCanvas.addEventListener('mousemove', drawPrimary);
            primarySignatureCanvas.addEventListener('mouseup', stopPrimaryDrawing);
            primarySignatureCanvas.addEventListener('mouseleave', stopPrimaryDrawing);

            // Touch events
            primarySignatureCanvas.addEventListener('touchstart', handlePrimaryTouchStart);
            primarySignatureCanvas.addEventListener('touchmove', handlePrimaryTouchMove);
            primarySignatureCanvas.addEventListener('touchend', stopPrimaryDrawing);
        }

        function startPrimaryDrawing(e) {
            primaryIsDrawing = true;
            const rect = primarySignatureCanvas.getBoundingClientRect();
            primarySignatureCtx.beginPath();
            primarySignatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function drawPrimary(e) {
            if (!primaryIsDrawing) return;
            const rect = primarySignatureCanvas.getBoundingClientRect();
            primarySignatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            primarySignatureCtx.stroke();
            primaryHasSignature = true;
            updateStep3dState();
        }

        function stopPrimaryDrawing() {
            if (primaryIsDrawing) {
                primaryIsDrawing = false;
                primarySignatureCtx.closePath();
            }
        }

        function handlePrimaryTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = primarySignatureCanvas.getBoundingClientRect();
            primaryIsDrawing = true;
            primarySignatureCtx.beginPath();
            primarySignatureCtx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
        }

        function handlePrimaryTouchMove(e) {
            e.preventDefault();
            if (!primaryIsDrawing) return;
            const touch = e.touches[0];
            const rect = primarySignatureCanvas.getBoundingClientRect();
            primarySignatureCtx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
            primarySignatureCtx.stroke();
            primaryHasSignature = true;
            updateStep3dState();
        }

        function clearPrimarySignature() {
            if (!primarySignatureCanvas || !primarySignatureCtx) return;
            primarySignatureCtx.clearRect(0, 0, primarySignatureCanvas.width, primarySignatureCanvas.height);
            primaryHasSignature = false;
            updateStep3dState();
        }

        function updateStep3bState() {
            const checked = document.getElementById('primaryAgree1').checked;
            document.getElementById('step3bNextBtn').disabled = !checked;
        }

        function updateStep3cState() {
            const checked = document.getElementById('primaryAgree2').checked;
            document.getElementById('step3cNextBtn').disabled = !checked;
        }

        function updateStep3dState() {
            document.getElementById('step3dNextBtn').disabled = !primaryHasSignature;
        }

        // Step 3c: Virtual Protocol
        function updatePrimaryVirtualState() {
            registrationState.primaryVirtualAgreed = document.getElementById('primaryVirtualAgree').checked;
            document.getElementById('step3cNextBtn').disabled = !registrationState.primaryVirtualAgreed;

            // Update checkbox styling
            const checkboxItem = document.getElementById('primaryVirtualAgree').parentElement;
            if (registrationState.primaryVirtualAgreed) {
                checkboxItem.classList.add('checked');
            } else {
                checkboxItem.classList.remove('checked');
            }
        }

        // Step 3d: Breach Acknowledgment
        function updatePrimaryBreachState() {
            registrationState.primaryBreachAck = document.getElementById('primaryBreachAck').checked;
            document.getElementById('step3dNextBtn').disabled = !registrationState.primaryBreachAck;

            // Update checkbox styling
            const checkboxItem = document.getElementById('primaryBreachAck').parentElement;
            if (registrationState.primaryBreachAck) {
                checkboxItem.classList.add('checked');
            } else {
                checkboxItem.classList.remove('checked');
            }
        }

        // Step 4: Designate Alternate
        function initializeStep4() {
            if (registrationState.primaryIsAttending) {
                // Primary IS attending - ask if they want to ALSO bring someone
                document.getElementById('step4IntroText').textContent = 'You can optionally designate an alternate from your institution to attend alongside you.';
                document.getElementById('step4QuestionText').textContent = 'Would you like to designate an alternate to attend with you?';
                document.getElementById('designateYesLabel').textContent = 'Yes, I would like to designate an alternate to attend with me';
                document.getElementById('designateNoLabel').textContent = 'No, I will be the only attendee from my institution';
            } else {
                // Primary NOT attending - ask if they want someone else to go
                document.getElementById('step4IntroText').textContent = 'Since you will not be attending, you can designate an alternate from your institution to attend in your place.';
                document.getElementById('step4QuestionText').textContent = 'Would you like to designate an alternate to attend?';
                document.getElementById('designateYesLabel').textContent = 'Yes, I would like to designate an alternate';
                document.getElementById('designateNoLabel').textContent = 'No, no one from my institution will attend';
            }
        }

        function selectDesignateAlternate(answer) {
            registrationState.hasDesignee = answer === 'yes';

            document.querySelectorAll('input[name="designateAlternate"]').forEach(input => {
                input.parentElement.classList.remove('selected');
            });

            const selectedRadio = document.getElementById(`designate${answer === 'yes' ? 'Yes' : 'No'}`);
            selectedRadio.checked = true;
            selectedRadio.parentElement.classList.add('selected');

            if (answer === 'no') {
                document.getElementById('noDesignateMessage').style.display = 'block';
            } else {
                document.getElementById('noDesignateMessage').style.display = 'none';
            }

            document.getElementById('step4NextBtn').disabled = false;
        }

        // Step 5: Alternate Selection
        function initializeStep5() {
            const container = document.getElementById('existingContacts');
            container.innerHTML = '';

            organizationContacts.forEach(contact => {
                const card = document.createElement('div');
                card.className = 'contact-card';
                card.onclick = () => selectExistingContact(contact);

                card.innerHTML = `
                    <input type="radio" name="alternateContact" id="contact-${contact.id}" style="margin-right: 1em;">
                    <div>
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-details">${contact.roleTitle || ''}</div>
                        <div class="contact-details">${contact.workEmail || ''}</div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function selectExistingContact(contact) {
            registrationState.designeeContact = contact;
            registrationState.designeeIsNew = false;

            document.querySelectorAll('.contact-card').forEach(card => {
                card.classList.remove('selected');
            });

            event.currentTarget.classList.add('selected');
            event.currentTarget.querySelector('input[type="radio"]').checked = true;

            document.getElementById('step5NextBtn').disabled = false;
        }

        function toggleNewPersonForm() {
            const form = document.getElementById('newPersonForm');
            const isVisible = form.style.display !== 'none';

            if (isVisible) {
                form.style.display = 'none';
            } else {
                form.style.display = 'block';
                // Deselect existing contacts
                document.querySelectorAll('.contact-card').forEach(card => {
                    card.classList.remove('selected');
                    card.querySelector('input[type="radio"]').checked = false;
                });
                registrationState.designeeIsNew = true;
                validateNewPersonForm();
            }
        }

        function validateNewPersonForm() {
            const name = document.getElementById('alternateName').value.trim();
            const title = document.getElementById('alternateTitle').value.trim();
            const email = document.getElementById('alternateEmail').value.trim();
            const phone = document.getElementById('alternatePhone').value.trim();

            const isValid = name && title && email && phone && email.includes('@');

            if (isValid) {
                registrationState.designeeContact = { name, title, email, phone, isNew: true };
                document.getElementById('step5NextBtn').disabled = false;
            } else {
                document.getElementById('step5NextBtn').disabled = true;
            }
        }

        // Add input listeners for new person form
        document.addEventListener('DOMContentLoaded', () => {
            ['alternateName', 'alternateTitle', 'alternateEmail', 'alternatePhone'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', validateNewPersonForm);
                }
            });
        });

        // Step 6: Alternate Format
        function initializeStep6() {
            const name = registrationState.designeeContact.name || 'your alternate';
            document.getElementById('alternateNameDisplay').textContent = name;
        }

        function selectAlternateFormat(format) {
            registrationState.designeeFormat = format;

            document.querySelectorAll('input[name="alternateFormat"]').forEach(input => {
                input.parentElement.classList.remove('selected');
            });

            const selectedRadio = document.getElementById(`alternateFormat${format === 'in-person' ? 'InPerson' : 'Virtual'}`);
            selectedRadio.checked = true;
            selectedRadio.parentElement.classList.add('selected');

            document.getElementById('step6NextBtn').disabled = false;
        }

        // Step 7: Certification
        function initializeStep7() {
            const name = registrationState.designeeContact.name || 'your alternate';
            document.getElementById('certificationAlternateName').textContent = name;
            document.getElementById('emailAlternateName').textContent = name;
        }

        function updateCertificationState() {
            const allChecked = ['certify1', 'certify2'].every(id => document.getElementById(id).checked);
            const hasFile = registrationState.certificationFile !== null;

            document.getElementById('step7NextBtn').disabled = !(allChecked && hasFile);

            // Update checkbox styling
            document.querySelectorAll('#step7Section .checkbox-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }
            });
        }

        async function handleCertificationUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                event.target.value = '';
                return;
            }

            registrationState.certificationFile = file;

            // Show file name
            document.getElementById('certificationFileName').textContent = `✓ ${file.name}`;
            document.getElementById('certificationFileName').style.display = 'block';
            document.getElementById('certificationUploadArea').classList.add('has-file');

            updateCertificationState();
        }

        // Step 8: Confirmation
        function initializeStep8() {
            let message = '';
            let nextSteps = '';

            if (registrationState.primaryIsAttending && registrationState.hasDesignee) {
                // Both attending
                message = `
                    <p><strong>Registration confirmed for both you and ${registrationState.designeeContact.name}.</strong></p>
                    <p>Both of you will attend the Managers & Directors Summit.</p>
                    <ul>
                        <li><strong>Your attendance:</strong> ${registrationState.primaryFormat === 'in-person' ? 'In-Person' : 'Virtual'}</li>
                        <li><strong>${registrationState.designeeContact.name}'s attendance:</strong> ${registrationState.designeeFormat === 'in-person' ? 'In-Person' : 'Virtual'}</li>
                    </ul>
                `;
                nextSteps = `
                    <p><strong>Next Steps:</strong></p>
                    <ul>
                        <li>${registrationState.designeeContact.name} will receive an email with a unique link to complete their confidentiality agreement</li>
                        <li>You will both receive confirmation emails with meeting details</li>
                        <li>Calendar invitations will be sent closer to the event date</li>
                    </ul>
                `;
            } else if (registrationState.primaryIsAttending && !registrationState.hasDesignee) {
                // Primary only
                message = `
                    <p><strong>Registration confirmed!</strong></p>
                    <p>You will attend the Managers & Directors Summit ${registrationState.primaryFormat === 'in-person' ? 'in person' : 'virtually'}.</p>
                `;
                nextSteps = `
                    <p><strong>Next Steps:</strong></p>
                    <ul>
                        <li>You will receive a confirmation email with meeting details</li>
                        <li>A calendar invitation will be sent closer to the event date</li>
                        ${registrationState.primaryFormat === 'virtual' ? '<li>Virtual attendance link and technical setup instructions will be provided</li>' : ''}
                    </ul>
                `;
            } else if (!registrationState.primaryIsAttending && registrationState.hasDesignee) {
                // Designee only
                message = `
                    <p><strong>Registration confirmed for ${registrationState.designeeContact.name}.</strong></p>
                    <p>They will attend the Managers & Directors Summit ${registrationState.designeeFormat === 'in-person' ? 'in person' : 'virtually'} on behalf of your institution.</p>
                `;
                nextSteps = `
                    <p><strong>Next Steps:</strong></p>
                    <ul>
                        <li>${registrationState.designeeContact.name} will receive an email with a unique link to complete their confidentiality agreement</li>
                        <li>Once they complete their agreement, both you and they will receive confirmation</li>
                        <li>They will receive all meeting details and calendar invitations</li>
                    </ul>
                `;
            } else {
                // No one attending
                message = `
                    <p><strong>Thank you for your response.</strong></p>
                    <p>Your institution will not have a representative at this year's Managers & Directors Summit.</p>
                `;
                nextSteps = `
                    <p>If you change your mind, please contact <a href="mailto:info@campusstores.ca">info@campusstores.ca</a></p>
                `;
            }

            document.getElementById('confirmationMessage').innerHTML = message;
            document.getElementById('nextStepsMessage').innerHTML = nextSteps;
        }

        // Navigation
        async function nextStep() {
            // Initialize next step if needed
            if (currentStep === 3 && registrationState.primaryIsAttending) {
                initializeStep4();
            } else if (currentStep === 4 && registrationState.hasDesignee) {
                initializeStep5();
            } else if (currentStep === 5 && registrationState.hasDesignee) {
                initializeStep6();
            } else if (currentStep === 6 && registrationState.hasDesignee) {
                initializeStep7();
            }

            // Handle conditional flow
            const nextStepSection = determineNextStep();

            if (nextStepSection === 'submit') {
                await submitRegistration();
                return;
            }

            // Hide current step
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Show next step
            document.getElementById(nextStepSection).classList.add('active');

            // Scroll to top
            window.scrollTo(0, 0);
        }

        function previousStep() {
            const prevStepSection = determinePreviousStep();

            // Hide current step
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Show previous step
            document.getElementById(prevStepSection).classList.add('active');

            // Scroll to top
            window.scrollTo(0, 0);
        }

        function determineNextStep() {
            const currentSection = document.querySelector('.content-section.active');
            const currentId = currentSection.id;

            switch(currentId) {
                case 'step1Section':
                    return 'step2Section';

                case 'step2Section':
                    // If attending, go to format selection; if not, go to designate alternate
                    return registrationState.primaryIsAttending ? 'step3aSection' : 'step4Section';

                case 'step3aSection':
                    return 'step3bSection';

                case 'step3bSection':
                    return 'step3cSection';

                case 'step3cSection':
                    return 'step3dSection';

                case 'step3dSection':
                    return 'step4Section';

                case 'step4Section':
                    // If designating, go to selection; otherwise submit
                    return registrationState.hasDesignee ? 'step5Section' : 'submit';

                case 'step5Section':
                    return 'step6Section';

                case 'step6Section':
                    return 'step7Section';

                case 'step7Section':
                    return 'submit';

                default:
                    return 'step1Section';
            }
        }

        function determinePreviousStep() {
            const currentSection = document.querySelector('.content-section.active');
            const currentId = currentSection.id;

            switch(currentId) {
                case 'step2Section':
                    return 'step1Section';

                case 'step3aSection':
                    return 'step2Section';

                case 'step3bSection':
                    return 'step3aSection';

                case 'step3cSection':
                    return 'step3bSection';

                case 'step3dSection':
                    return 'step3cSection';

                case 'step4Section':
                    // If primary attending, came from breach ack; otherwise came from step 2
                    return registrationState.primaryIsAttending ? 'step3dSection' : 'step2Section';

                case 'step5Section':
                    return 'step4Section';

                case 'step6Section':
                    return 'step5Section';

                case 'step7Section':
                    return 'step6Section';

                default:
                    return 'welcomeSection';
            }
        }

        async function submitRegistration() {
            showLoading();

            try {
                // Upload files first
                const uploadedFiles = await uploadFiles();

                // Submit registration data
                const response = await fetch('/api/submit-summit-registration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        organizationId: organizationData.id,
                        primaryIsAttending: registrationState.primaryIsAttending,
                        primaryFormat: registrationState.primaryFormat,
                        primaryAgreementUrl: uploadedFiles.primaryAgreement,
                        hasDesignee: registrationState.hasDesignee,
                        designeeContact: registrationState.designeeContact,
                        designeeFormat: registrationState.designeeFormat,
                        certificationUrl: uploadedFiles.certification
                    })
                });

                const result = await response.json();

                if (result.success) {
                    initializeStep8();
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    document.getElementById('step8Section').classList.add('active');
                    hideLoading();
                } else {
                    throw new Error(result.error || 'Submission failed');
                }
            } catch (error) {
                console.error('Submission error:', error);
                alert('Error submitting registration. Please try again.');
                hideLoading();
            }
        }

        async function uploadFiles() {
            const files = [];

            // Get signature from canvas if present
            if (primaryHasSignature && primarySignatureCanvas) {
                const signatureDataUrl = primarySignatureCanvas.toDataURL('image/png');
                const signatureBase64 = signatureDataUrl.split(',')[1];

                files.push({
                    name: `signature_${Date.now()}.png`,
                    content: signatureBase64,
                    type: 'image/png',
                    fieldName: 'primaryAgreement'
                });
            }

            if (registrationState.certificationFile) {
                const reader = new FileReader();
                const certificationBase64 = await new Promise((resolve) => {
                    reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                    reader.readAsDataURL(registrationState.certificationFile);
                });

                files.push({
                    name: registrationState.certificationFile.name,
                    content: certificationBase64,
                    type: registrationState.certificationFile.type,
                    fieldName: 'certification'
                });
            }

            if (files.length === 0) return {};

            const response = await fetch('/api/upload-summit-files', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    files: files,
                    organizationName: organizationData.organizationName,
                    token: token
                })
            });

            const result = await response.json();
            return result.urls || {};
        }
    </script>

    <!-- Primary Member Edit Modal -->
    <div id="primaryMemberModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Your Details</h2>
                <button class="modal-close" onclick="closePrimaryMemberModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-field">
                    <label>Name <span class="required">*</span></label>
                    <input type="text" id="pmName" placeholder="Enter your full name">
                    <div class="error-message" id="pmNameError">Name is required</div>
                </div>
                <div class="modal-field">
                    <label>Title <span class="required">*</span></label>
                    <input type="text" id="pmTitle" placeholder="Enter your title">
                    <div class="error-message" id="pmTitleError">Title is required</div>
                </div>
                <div class="modal-field">
                    <label>Email <span class="required">*</span></label>
                    <input type="email" id="pmEmail" placeholder="Enter your email">
                    <div class="error-message" id="pmEmailError">Valid email is required</div>
                </div>
                <div class="modal-field">
                    <label>Phone <span class="required">*</span></label>
                    <input type="tel" id="pmPhone" placeholder="(XXX) XXX-XXXX">
                    <div class="error-message" id="pmPhoneError">Valid phone number is required</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-cancel-btn" onclick="closePrimaryMemberModal()">Cancel</button>
                <button class="modal-save-btn" onclick="savePrimaryMemberDetails()">Save Changes</button>
            </div>
        </div>
    </div>

</body>
</html>
